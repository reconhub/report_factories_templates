---
title: "Temporal trends"
author: "Arthur Fitzmaurice, Thibaut Jombart, Christopher Jarvis, Jonathan Polonsky, Amy Gimma for the analytic cell EOC Goma"
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: zenburn
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_collapse: no
    toc_depth: 4
    toc_float: yes
    css: !expr here::here('css', 'style.css')
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      collapse = TRUE,
                      fig.width = 10,
                      fig.height = 6,
                      dpi = 150,
                      warning = FALSE,
                      message = FALSE)
```



<br>

<div class="report_meta">
  <span class="notice">**Notice**: this is a **stable, routine report**. 
  **Do not touch it unless it is broken.** To make a contribution, **carefully read 
  the [README](../../../../../README.html) file**.</span>
  
  **Maintainer:** Thibaut Jombart (thibautjombart@gmail.com)
  
  **Code contributors:** Arthur Fitzmaurice, Christopher Jarvis, Thibaut Jombart, Amy Gimma
  
  **Data contributors:** Yannick Tutu, Richy Ngombo
  
  **Version:** 2.1.0
  
  **Reviewed by:** Thibaut Jombart
</div>






<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# Data preparation {.tabset .tabset-fade .tabset-pills}

<!-- ======================================================= -->
## Outline

This report summarise the age and sex distribution of cases overall, and
stratified by geographic unit.

### Data used

The master linelist.

### Method

The data preparation involves the following steps, detailed in the following tabs:


* **Load scripts**: loads libraries and useful scripts used in the analyses; all
`.R` files contained in `scripts` at the root of the factory are automatically
loaded

* **Load data**: imports datasets, and may contain some *ad hoc* changes to the
data such as specific data cleaning (not used in other reports), new variables
used in the analyses, etc.

* **Clean data**: this section contains *ad hoc* data cleaning, i.e. which is
not used in other reports (otherwise cleaning should be done in a dedicated
report); this section is also used to create new variables used in the
analyses




<!-- ======================================================= -->
## Load scripts

These scripts will load:

* all local scripts, stored as `.R` filesinside `/scripts/`
* all global scripts, i.e. stored outside the factory in `../scripts/`
* the path to the cleaned VHF data stored as `x`

```{r read_scripts}

## read scripts
path_to_scripts <- here::here("scripts")
scripts_files <- dir(path_to_scripts, pattern = ".R$",
                     full.names = TRUE)
for (file in scripts_files) source(file, local = TRUE)

ggthemr('grape')

```



<!-- ======================================================= -->
## Load data

We extract the completion date from the file name:

```{r load_data}

## load the data
current_clean_data
x <- rio::import(current_clean_data)

## extract database date from the file name
file_name <- gsub("^[^.]+/", "", current_clean_data)
database_date <- file_name %>%
  guess_dates()
database_date

```

The **completion date** of the database is **`r format(database_date, format =
"%A %d %b %Y")`**.





<!-- ======================================================= -->
## Add variables

We add the following new variables 

* `recent`: cases reported within the last 42 days (from the database date)
* `top_zones`: 7 zones who reported the most cases over the last 42 days


```{r add_top_zones}

start_at <- database_date - 42

x <- x %>%
  mutate(recent = date_report >= start_at, 
         top_zones = top_values(zone_de_sante, 7, subset = recent))

```




<!-- ======================================================= -->
## Filter data

We retain only entries:

* reported from the 1st January 2019
* corresponding to confirmed and probable cases

```{r filter}

x <- x %>%
  filter(date_report >= as.Date("2019-01-01"),
         epicasedef %in% c("confirmed", "probable"))

```



## Custom colors

In this part we define custom colors and color scales for further plotting.

```{r custom_colors}

color_known_contact <- "#117A65"
color_followed_contact <- "#073a30"
color_community_death <- "#DD5327"
color_hcw <- "#8A0829"

```











<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# Contacts: known/unknown {.tabset .tabset-fade .tabset-pills}

<!-- ======================================================= -->
## Outline 

We use the variable `contact_registered` to estimate the proportions of cases
who are known contacts:

* overall, weekly 
* by sub-coordination, monthly
* for the main recently active health zones, monthly

Each analysis will present:

* overall results aggregated for the whole time period
* a temporal breakdown

For each proportion, we derive the exact binomial confidence interval.



<!-- ======================================================= -->
## Note

We will rely on `adorn_totals` for computing totals. This approach needs to take into account an
[issue](https://github.com/sfirke/janitor/issues/285) with `adorn_totals`, which
ignores the first column of data assuming it is a grouping factor. This will not
be a problem for further stratification, where the function can be used safely.



<!-- ======================================================= -->
## Overall

The analysis proceeds with the following steps:

1. calculate overall numbers and corresponding proportions and confidence
intervals

2. calculate weekly numbers and corresponding proportions and confidence
intervals

3. plot temporal trends

4. create a table from 1, renaming columns and displaying it 

5. create a table from 2, renaming columns and displaying it 


```{r contacts_overall}

## step 1
contacts_overall <- x %>%
  count(contact_registered) %>%
  spread(contact_registered, n, fill = 0, drop = FALSE) %>%
  mutate(total = nrow(x), # avoid adorn_totals
         denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 2
contacts_overall_time <- x %>%
  count(epiweek_report_label, contact_registered) %>%
  spread(contact_registered, n, fill = 0, drop = FALSE) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 3
ggplot(contacts_overall_time, aes(x = epiweek_report_label, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_known_contact) +
  geom_point(color = color_known_contact) +
  geom_line(color = color_known_contact) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_months +
  rotate_x_text(45) +
  large_txt +
  labs(title = "Proportion de cas connus comme contacts",
       x = "Semaine de notification",
       y = "% de cas hebdomadaires connus comme contact")


## step 4
table_contacts_overall <- contacts_overall %>% 
  select("% contact connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_contacts_overall %>%
  show_table()


# step 5
table_contacts_overall_time <- contacts_overall_time %>% 
  select(semaine = epiweek_report_label,
         "% contact connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_contacts_overall_time %>%
  show_table()

```






<!-- ======================================================= -->
## By sub-coordination

The analysis proceeds with the following steps:

1. calculate numbers by sub-coordination and corresponding proportions and
confidence intervals

2. calculate monthly numbers and corresponding proportions and confidence
intervals

3. plot overall numbers by sub-coordination

4. plot temporal trends, retaining only sub-coordinations for which the average
monthly uncertainty is less than 60%

5. create a table from 1, renaming columns and displaying it 

6. create a table from 2, renaming columns and displaying it 


```{r contacts_sub_coordination}

## step 1
contacts_sub_coordination <- x %>%
  count(sous_coordination, contact_registered) %>%
  spread(contact_registered, n, fill = 0, drop = FALSE) %>%
  adorn_totals("col", name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 2
contacts_sub_coordination_time <- x %>%
  count(sous_coordination, month_report, contact_registered) %>%
  spread(contact_registered, n, fill = 0) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 3
ggplot(contacts_sub_coordination, aes(x = sous_coordination, y = p)) +
  theme_bw() +
  geom_errorbar(aes(ymin = p_lower, ymax = p_upper),
                color = color_known_contact) +
  geom_point(color = color_known_contact, size = 2) +
  geom_label(aes(y = p_upper + 10, label = paste0("n=", denom))) +
  large_txt +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, by = 20),
                     limit = c(0, 110)) +
  labs(title = "Proportion de cas connus comme contacts\npar sous-coordination",
       x = "",
       y = "% de cas connus comme contacts")


## step 4
to_keep <- contacts_sub_coordination_time %>%
  group_by(sous_coordination) %>%
  filter(mean(p_upper - p_lower) < 60) %>%
  pull(sous_coordination) %>%
  unique()

contacts_sub_coordination_time %>%
  filter(sous_coordination %in% to_keep) %>% 
  ggplot(aes(x = month_report, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_known_contact) +
  geom_point(color = color_known_contact) +
  geom_line(color = color_known_contact) +
  scale_months +
  rotate_x_text(45) +
  facet_wrap(sous_coordination ~ ., nrow = 2) +
  large_txt +
  custom_vert_facet +
  labs(title = "Proportion de cas connus comme contacts",
       x = "Mois de notification",
       y = "% de cas mensuels connus comme contact")


## step 5
table_contacts_sub_coordination <- contacts_sub_coordination %>% 
  select(sous_coordination,
         "% contact connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_contacts_sub_coordination %>%
  show_table()


# step 6
table_contacts_sub_coordination_time <- contacts_sub_coordination_time %>% 
  select(mois = month_report,
         sous_coordination,
         "% contact connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_contacts_sub_coordination_time %>%
  show_table()

```



<!-- ======================================================= -->
## By top zones

The analysis proceeds with the following steps:

1. calculate numbers by zone and corresponding proportions and
confidence intervals, constrained to top zones in recent 42 days

2. calculate monthly numbers and corresponding proportions and confidence
intervals

3. plot overall numbers by zone, constrained to top zones in recent 42 days

4. plot temporal trends, retaining only sub-coordinations for which the average
monthly uncertainty is less than 60%

5. create a table from 1, renaming columns and displaying it 

6. create a table from 2, renaming columns and displaying it 


```{r contacts_top_zones}

## step 1
contacts_top_zones <- x %>%
  count(top_zones, contact_registered) %>%
  spread(contact_registered, n, fill = 0, drop = FALSE) %>%
  adorn_totals("col", name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 2
contacts_top_zones_time <- x %>%
  count(top_zones, month_report, contact_registered) %>%
  spread(contact_registered, n, fill = 0) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 3
ggplot(contacts_top_zones, aes(x = top_zones, y = p)) +
  theme_bw() +
  geom_errorbar(aes(ymin = p_lower, ymax = p_upper),
                color = color_known_contact) +
  geom_point(color = color_known_contact, size = 2) +
  geom_label(aes(y = p_upper + 10, label = paste0("n=", denom))) +
  large_txt +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, by = 20),
                     limit = c(0, 110)) +
  labs(title = "Proportion de cas connus comme contacts\npar zone de santé",
       x = "",
       y = "% de cas connus comme contacts")


## step 4
to_keep <- contacts_top_zones_time %>%
  group_by(top_zones) %>%
  filter(mean(p_upper - p_lower) < 60) %>%
  pull(top_zones) %>%
  unique()

contacts_top_zones_time %>%
  filter(top_zones %in% to_keep) %>% 
  ggplot(aes(x = month_report, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_known_contact) +
  geom_point(color = color_known_contact) +
  geom_line(color = color_known_contact) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_months +
  rotate_x_text(45) +
  facet_wrap(top_zones ~ ., nrow = 2) +
  large_txt +
  custom_vert_facet +
  labs(title = "Proportion de cas connus comme contacts",
       x = "Mois de notification",
       y = "% de cas mensuels connus comme contact")


## step 5
table_contacts_top_zones <- contacts_top_zones %>% 
  select(top_zones,
         "% contact connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_contacts_top_zones %>%
  show_table()


## step 6
table_contacts_top_zones_time <- contacts_top_zones_time %>% 
  select(mois = month_report,
         top_zones,
         "% contact connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_contacts_top_zones_time %>%
  show_table()

```







<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# Contacts: known & followed {.tabset .tabset-fade .tabset-pills}

<!-- ======================================================= -->
## Outline 

We use the variable `contact_surveilled` to estimate the proportions of cases
who are known and followed contacts:

* overall, weekly 
* by sub-coordination, monthly
* for the main recently active health zones, monthly

Each analysis will present:

* overall results aggregated for the whole time period
* a temporal breakdown

For each proportion, we derive the exact binomial confidence interval.


<!-- ======================================================= -->
## Note

We will rely on `adorn_totals` for computing totals. This approach needs to take
into account an [issue](https://github.com/sfirke/janitor/issues/285) with
`adorn_totals`, which ignores the first column of data assuming it is a grouping
factor. This will not be a problem for further stratification, where the
function can be used safely.



<!-- ======================================================= -->
## Overall

The analysis proceeds with the following steps:

1. calculate overall numbers and corresponding proportions and confidence intervals

2. calculate weekly numbers and corresponding proportions and confidence intervals

3. plot temporal trends

4. create a table from 1, renaming columns and displaying it 

5. create a table from 2, renaming columns and displaying it 


```{r followed_overall}
      
## step 1
followed_overall <- x %>%
  count(contact_surveilled) %>%
  spread(contact_surveilled, n, fill = 0, drop = FALSE) %>%
  mutate(total = nrow(x), # avoid adorn_totals
         denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 2
followed_overall_time <- x %>%
  count(epiweek_report_label, contact_surveilled) %>%
  spread(contact_surveilled, n, fill = 0, drop = FALSE) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 3
ggplot(followed_overall_time, aes(x = epiweek_report_label, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_followed_contact) +
  geom_point(color = color_followed_contact) +
  geom_line(color = color_followed_contact) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_months +
  rotate_x_text(45) +
  large_txt +
  labs(title = "Proportion de cas connus comme contacts et suivi",
       x = "Semaine de notification",
       y = "% de cas hebdomadaires\nconnus comme contact et suivi")


## step 4
table_followed_overall <- followed_overall %>% 
  select("% contact connu et suivi" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_followed_overall %>%
  show_table()


                                        # step 5
table_followed_overall_time <- followed_overall_time %>% 
  select(semaine = epiweek_report_label,
         "% contact connu et suivi" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_followed_overall_time %>%
  show_table()
      
```




<!-- ======================================================= -->
## By sub-coordination

The analysis proceeds with the following steps:

1. calculate numbers by sub-coordination and corresponding proportions and confidence intervals

2. calculate monthly numbers and corresponding proportions and confidence intervals

3. plot overall numbers by sub-coordination

4. plot temporal trends, retaining only sub-coordinations for which the average
monthly uncertainty is less than 60%

5. create a table from 1, renaming columns and displaying it 

6. create a table from 2, renaming columns and displaying it 


```{r followed_sub_coordination}

## step 1
followed_sub_coordination <- x %>%
  count(sous_coordination, contact_surveilled) %>%
  spread(contact_surveilled, n, fill = 0, drop = FALSE) %>%
  adorn_totals("col", name = "total") %>% 
  mutate(denom = total - unknown,
        p = prop_to_perc(yes / denom),
        p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
        p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 2
followed_sub_coordination_time <- x %>%
  count(sous_coordination, month_report, contact_surveilled) %>%
  spread(contact_surveilled, n, fill = 0) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total - unknown,
        p = prop_to_perc(yes / denom),
        p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
        p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 3
ggplot(followed_sub_coordination, aes(x = sous_coordination, y = p)) +
  theme_bw() +
  geom_errorbar(aes(ymin = p_lower, ymax = p_upper),
    color = color_followed_contact) +
  geom_point(color = color_followed_contact, size = 2) +
  geom_label(aes(y = p_upper + 10, label = paste0("n=", denom))) +
  large_txt +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, by = 20),
    limit = c(0, 110)) +
  labs(title = "Proportion de cas connus comme contacts et suivi\npar sous-coordination",
    x = "",
    y = "% de cas connus comme contacts et suivi")


## step 4
to_keep <- followed_sub_coordination_time %>%
  group_by(sous_coordination) %>%
  filter(mean(p_upper - p_lower) < 60) %>%
  pull(sous_coordination) %>%
  unique()

followed_sub_coordination_time %>%
  filter(sous_coordination %in% to_keep) %>% 
ggplot(aes(x = month_report, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
    alpha = .3, fill = color_followed_contact) +
  geom_point(color = color_followed_contact) +
  geom_line(color = color_followed_contact) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_months +
  rotate_x_text(45) +
  facet_wrap(sous_coordination ~ ., nrow = 2) +
  large_txt +
  custom_vert_facet +
  labs(title = "Proportion de cas connus comme contacts et suivi",
    x = "Mois de notification",
    y = "% de cas mensuels connus comme contact et suivi")


## step 5
table_followed_sub_coordination <- followed_sub_coordination %>% 
  select(sous_coordination,
        "% contact connu et suivi" = p,
        "IC95% lower" = p_lower,
        "IC95% upper" = p_upper,
        n = denom,
        everything())

table_followed_sub_coordination %>%
  show_table()


# step 6
table_followed_sub_coordination_time <- followed_sub_coordination_time %>% 
  select(mois = month_report,
         sous_coordination,
         "% contact connu et suivi" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_followed_sub_coordination_time %>%
  show_table()

```



<!-- ======================================================= -->
## By top zones

The analysis proceeds with the following steps:

1. calculate numbers by zone and corresponding proportions and confidence intervals,
constrained to top zones in recent 42 days

2. calculate monthly numbers and corresponding proportions and confidence intervals

3. plot overall numbers by top zones, constrained to top zones in recent 42 days

4. plot temporal trends, retaining only top zoness for which the average
monthly uncertainty is less than 60%

5. create a table from 1, renaming columns and displaying it 

6. create a table from 2, renaming columns and displaying it 


```{r followed_top_zones}

## step 1
followed_top_zones <- x %>%
  count(top_zones, contact_surveilled) %>%
  spread(contact_surveilled, n, fill = 0, drop = FALSE) %>%
  adorn_totals("col", name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 2
followed_top_zones_time <- x %>%
  count(top_zones, month_report, contact_surveilled) %>%
  spread(contact_surveilled, n, fill = 0) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(yes / denom),
         p_lower = prop_ci(yes, denom, "lower", perc = TRUE),
         p_upper = prop_ci(yes, denom, "upper", perc = TRUE))


## step 3
ggplot(followed_top_zones, aes(x = top_zones, y = p)) +
  theme_bw() +
  geom_errorbar(aes(ymin = p_lower, ymax = p_upper),
                color = color_followed_contact) +
  geom_point(color = color_followed_contact, size = 2) +
  geom_label(aes(y = p_upper + 10, label = paste0("n=", denom))) +
  large_txt +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, by = 20),
                     limit = c(0, 110)) +
  labs(title = "Proportion de cas connus comme contacts et suivi\npar zone de santé",
       x = "",
       y = "% de cas connus comme contacts et suivi")


## step 4
to_keep <- followed_top_zones_time %>%
  group_by(top_zones) %>%
  filter(mean(p_upper - p_lower) < 60) %>%
  pull(top_zones) %>%
  unique()

followed_top_zones_time %>%
  filter(top_zones %in% to_keep) %>% 
ggplot(aes(x = month_report, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_followed_contact) +
  geom_point(color = color_followed_contact) +
  geom_line(color = color_followed_contact) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_months +
  rotate_x_text(45) +
  facet_wrap(top_zones ~ ., nrow = 2) +
  large_txt +
  custom_vert_facet +
  labs(title = "Proportion de cas connus comme contacts et suivi",
       x = "Mois de notification",
       y = "% de cas mensuels connus comme contact et suivi")


## step 5
table_followed_top_zones <- followed_top_zones %>% 
  select(top_zones,
         "% contact connu et suivi" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_followed_top_zones %>%
  show_table()


# step 6
table_followed_top_zones_time <- followed_top_zones_time %>% 
  select(mois = month_report,
         top_zones,
         "% contact connu et suivi" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_followed_top_zones_time %>%
  show_table()

```






<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# Community deaths {.tabset .tabset-fade .tabset-pills}

<!-- ======================================================= -->
## Outline 

We use the variable `community_death_registered` to estimate the proportions of cases
who are known community_deaths:

* overall, weekly 
* by sub-coordination, monthly
* for the main recently active health zones, monthly

Each analysis will present:

* overall results aggregated for the whole time period
* a temporal breakdown

For each proportion, we derive the exact binomial confidence interval.



<!-- ======================================================= -->
## Note

We will rely on `adorn_totals` for computing totals. This approach needs to take into account an
[issue](https://github.com/sfirke/janitor/issues/285) with `adorn_totals`, which
ignores the first column of data assuming it is a grouping factor. This will not
be a problem for further stratification, where the function can be used safely.



<!-- ======================================================= -->
## Overall

The analysis proceeds with the following steps:

1. calculate overall numbers and corresponding proportions and confidence
intervals

2. calculate weekly numbers and corresponding proportions and confidence
intervals

3. plot temporal trends

4. create a table from 1, renaming columns and displaying it 

5. create a table from 2, renaming columns and displaying it 


```{r community_deaths_overall}

## step 1
community_deaths_overall <- x %>%
  count(type_death) %>%
  spread(type_death, n, fill = 0, drop = FALSE) %>%
  mutate(total = nrow(x), # avoid adorn_totals
         denom = total - unknown,
         p = prop_to_perc(community / denom),
         p_lower = prop_ci(community, denom, "lower", perc = TRUE),
         p_upper = prop_ci(community, denom, "upper", perc = TRUE))


## step 2
community_deaths_overall_time <- x %>%
  count(epiweek_report_label, type_death) %>%
  spread(type_death, n, fill = 0, drop = FALSE) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total,
         p = prop_to_perc(community / denom),
         p_lower = prop_ci(community, denom, "lower", perc = TRUE),
         p_upper = prop_ci(community, denom, "upper", perc = TRUE))


## step 3
ggplot(community_deaths_overall_time, aes(x = epiweek_report_label, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_community_death) +
  geom_point(color = color_community_death) +
  geom_line(color = color_community_death) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_months +
  rotate_x_text(45) +
  large_txt +
  labs(title = "Proportion de décès communautaires",
       x = "Semaine de notification",
       y = "% de cas hebdomadaires décès communautaires")


## step 4
table_community_deaths_overall <- community_deaths_overall %>% 
  select("% community_death connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_community_deaths_overall %>%
  show_table()


# step 5
table_community_deaths_overall_time <- community_deaths_overall_time %>% 
  select(semaine = epiweek_report_label,
         "% community_death connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_community_deaths_overall_time %>%
  show_table()

```






<!-- ======================================================= -->
## By sub-coordination

The analysis proceeds with the following steps:

1. calculate numbers by sub-coordination and corresponding proportions and
confidence intervals

2. calculate monthly numbers and corresponding proportions and confidence
intervals

3. plot overall numbers by sub-coordination

4. plot temporal trends, retaining only sub-coordinations for which the average
monthly uncertainty is less than 60%

5. create a table from 1, renaming columns and displaying it 

6. create a table from 2, renaming columns and displaying it 


```{r community_deaths_sub_coordination}

## step 1
community_deaths_sub_coordination <- x %>%
  count(sous_coordination, type_death) %>%
  spread(type_death, n, fill = 0, drop = FALSE) %>%
  adorn_totals("col", name = "total") %>% 
  mutate(denom = total,
         p = prop_to_perc(community / denom),
         p_lower = prop_ci(community, denom, "lower", perc = TRUE),
         p_upper = prop_ci(community, denom, "upper", perc = TRUE))


## step 2
community_deaths_sub_coordination_time <- x %>%
  count(sous_coordination, month_report, type_death) %>%
  spread(type_death, n, fill = 0) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total,
         p = prop_to_perc(community / denom),
         p_lower = prop_ci(community, denom, "lower", perc = TRUE),
         p_upper = prop_ci(community, denom, "upper", perc = TRUE))


## step 3
ggplot(community_deaths_sub_coordination, aes(x = sous_coordination, y = p)) +
  theme_bw() +
  geom_errorbar(aes(ymin = p_lower, ymax = p_upper),
                color = color_community_death) +
  geom_point(color = color_community_death, size = 2) +
  geom_label(aes(y = p_upper + 10, label = paste0("n=", denom))) +
  large_txt +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, by = 20),
                     limit = c(0, 110)) +
  labs(title = "Proportion de décès communautaires\npar sous-coordination",
       x = "",
       y = "% de décès communautaires")


## step 4
to_keep <- community_deaths_sub_coordination_time %>%
  group_by(sous_coordination) %>%
  filter(mean(p_upper - p_lower) < 60) %>%
  pull(sous_coordination) %>%
  unique()

community_deaths_sub_coordination_time %>%
  filter(sous_coordination %in% to_keep) %>% 
ggplot(aes(x = month_report, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_community_death) +
  geom_point(color = color_community_death) +
  geom_line(color = color_community_death) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_months +
  rotate_x_text(45) +
  facet_wrap(sous_coordination ~ ., nrow = 2) +
  large_txt +
  custom_vert_facet +
  labs(title = "Proportion de décès communautaires",
       x = "Mois de notification",
       y = "% de décès communautaires")


## step 5
table_community_deaths_sub_coordination <- community_deaths_sub_coordination %>% 
  select(sous_coordination,
         "% community_death connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_community_deaths_sub_coordination %>%
  show_table()


# step 6
table_community_deaths_sub_coordination_time <- community_deaths_sub_coordination_time %>% 
  select(mois = month_report,
         sous_coordination,
         "% community_death connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_community_deaths_sub_coordination_time %>%
  show_table()

```



<!-- ======================================================= -->
## By top zones

The analysis proceeds with the following steps:

1. calculate numbers by zone and corresponding proportions and
confidence intervals, constrained to top zones in recent 42 days

2. calculate monthly numbers and corresponding proportions and confidence
intervals

3. plot overall numbers by zone, constrained to top zones in recent 42 days

4. plot temporal trends, retaining only zones for which the average
monthly uncertainty is less than 60%

5. create a table from 1, renaming columns and displaying it 

6. create a table from 2, renaming columns and displaying it 


```{r community_deaths_top_zones}

## step 1
community_deaths_top_zones <- x %>%
  count(top_zones, type_death) %>%
  spread(type_death, n, fill = 0, drop = FALSE) %>%
  adorn_totals("col", name = "total") %>% 
  mutate(denom = total,
         p = prop_to_perc(community / denom),
         p_lower = prop_ci(community, denom, "lower", perc = TRUE),
         p_upper = prop_ci(community, denom, "upper", perc = TRUE))


## step 2
community_deaths_top_zones_time <- x %>%
  count(top_zones, month_report, type_death) %>%
  spread(type_death, n, fill = 0) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total,
         p = prop_to_perc(community / denom),
         p_lower = prop_ci(community, denom, "lower", perc = TRUE),
         p_upper = prop_ci(community, denom, "upper", perc = TRUE))


## step 3
ggplot(community_deaths_top_zones, aes(x = top_zones, y = p)) +
  theme_bw() +
  geom_errorbar(aes(ymin = p_lower, ymax = p_upper),
                color = color_community_death) +
  geom_point(color = color_community_death, size = 2) +
  geom_label(aes(y = p_upper + 10, label = paste0("n=", denom))) +
  large_txt +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, by = 20),
                     limit = c(0, 110)) +
  labs(title = "Proportion de décès communautaires\npar zone de santé",
       x = "",
       y = "% de décès communautaires")


## step 4
to_keep <- community_deaths_top_zones_time %>%
  group_by(top_zones) %>%
  filter(mean(p_upper - p_lower) < 60) %>%
  pull(top_zones) %>%
  unique()

community_deaths_top_zones_time %>%
  filter(top_zones %in% to_keep) %>% 
ggplot(aes(x = month_report, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_community_death) +
  geom_point(color = color_community_death) +
  geom_line(color = color_community_death) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_months +
  rotate_x_text(45) +
  facet_wrap(top_zones ~ ., nrow = 2) +
  large_txt +
  custom_vert_facet +
  labs(title = "Proportion de décès communautaires",
       x = "Mois de notification",
       y = "% de décès communautaires")


## step 5
table_community_deaths_top_zones <- community_deaths_top_zones %>% 
  select(top_zones,
         "% community_death connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_community_deaths_top_zones %>%
  show_table()


# step 6
table_community_deaths_top_zones_time <- community_deaths_top_zones_time %>% 
  select(mois = month_report,
         top_zones,
         "% community_death connu" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_community_deaths_top_zones_time %>%
  show_table()

```





<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# Healthcare worker cases {.tabset .tabset-fade .tabset-pills}

<!-- ======================================================= -->
## Outline 

We use the variable `hcw` to estimate the proportions of cases
who are healthcare workers:

* overall, monthly
* by sub-coordination, monthly

Each analysis will present:

* overall results aggregated for the whole time period
* a temporal breakdown

For each proportion, we derive the exact binomial confidence interval.



<!-- ======================================================= -->
## Note

We will rely on `adorn_totals` for computing totals. This approach needs to take into account an
[issue](https://github.com/sfirke/janitor/issues/285) with `adorn_totals`, which
ignores the first column of data assuming it is a grouping factor. This will not
be a problem for further stratification, where the function can be used safely.



<!-- ======================================================= -->
## Overall

The analysis proceeds with the following steps:

1. calculate overall numbers and corresponding proportions and confidence intervals

2. calculate monthly numbers and corresponding proportions and confidence intervals

3. plot temporal trends

4. create a table from 1, renaming columns and displaying it 

5. create a table from 2, renaming columns and displaying it 


```{r hcw_overall}
      
## step 1
hcw_overall <- x %>%
  count(hcw) %>%
  spread(hcw, n, fill = 0, drop = FALSE) %>%
  mutate(total = nrow(x), # avoid adorn_totals
         denom = total - unknown,
         p = prop_to_perc(hcw / denom),
         p_lower = prop_ci(hcw, denom, "lower", perc = TRUE),
         p_upper = prop_ci(hcw, denom, "upper", perc = TRUE))
      
      
## step 2
hcw_overall_time <- x %>%
  count(month_report, hcw) %>%
  spread(hcw, n, fill = 0, drop = FALSE) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(hcw / denom),
         p_lower = prop_ci(hcw, denom, "lower", perc = TRUE),
         p_upper = prop_ci(hcw, denom, "upper", perc = TRUE))
      
      
## step 3
ggplot(hcw_overall_time, aes(x = month_report, y = p)) +
        theme_bw() +
        geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_hcw) +
        geom_point(color = color_hcw) +
        geom_line(color = color_hcw) +
        scale_months +
        rotate_x_text(45) +
        large_txt +
        labs(title = "Proportion de cas qui sont des travailleurs de la santé",
             x = "Mois de notification",
             y = "% de cas mensuels")
      
      
## step 4
table_hcw_overall <- hcw_overall %>% 
  select("% travailleurs de la santé" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_hcw_overall %>%
  show_table()


                                        # step 5
table_hcw_overall_time <- hcw_overall_time %>% 
  select(moi = month_report,
         "% travailleurs de la santé" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())
      
table_hcw_overall_time %>%
  show_table()
      
```






<!-- ======================================================= -->
## By sub-coordination

The analysis proceeds with the following steps:

1. calculate numbers by sub-coordination and corresponding proportions and
confidence intervals

2. calculate monthly numbers and corresponding proportions and confidence
intervals

3. plot overall numbers by sub-coordination

4. plot temporal trends, retaining only sub-coordinations for which the average
monthly uncertainty is less than 60%

5. create a table from 1, renaming columns and displaying it 

6. create a table from 2, renaming columns and displaying it 


```{r hcw_sub_coordination}

## step 1
hcw_sub_coordination <- x %>%
  count(sous_coordination, hcw) %>%
  spread(hcw, n, fill = 0, drop = FALSE) %>%
  adorn_totals("col", name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(hcw / denom),
         p_lower = prop_ci(hcw, denom, "lower", perc = TRUE),
         p_upper = prop_ci(hcw, denom, "upper", perc = TRUE))


## step 2
hcw_sub_coordination_time <- x %>%
  count(sous_coordination, month_report, hcw) %>%
  spread(hcw, n, fill = 0) %>%
  adorn_totals(c("col"), name = "total") %>% 
  mutate(denom = total - unknown,
         p = prop_to_perc(hcw / denom),
         p_lower = prop_ci(hcw, denom, "lower", perc = TRUE),
         p_upper = prop_ci(hcw, denom, "upper", perc = TRUE))


## step 3
ggplot(hcw_sub_coordination, aes(x = sous_coordination, y = p)) +
  theme_bw() +
  geom_errorbar(aes(ymin = p_lower, ymax = p_upper),
                color = color_hcw) +
  geom_point(color = color_hcw, size = 2) +
  geom_label(aes(y = p_upper + 10, label = paste0("n=", denom))) +
  large_txt +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, by = 20),
                     limit = c(0, 110)) +
  labs(title = "Proportion de cas qui sont des travailleurs de la santé\npar sous-coordination",
       x = "",
       y = "% de cas qui sont des travailleurs de la santé")


## step 4
to_keep <- hcw_sub_coordination_time %>%
  group_by(sous_coordination) %>%
  filter(mean(p_upper - p_lower) < 60) %>%
  pull(sous_coordination) %>%
  unique()

hcw_sub_coordination_time %>%
  filter(sous_coordination %in% to_keep) %>% 
  ggplot(aes(x = month_report, y = p)) +
  theme_bw() +
  geom_ribbon(aes(ymin = p_lower, ymax = p_upper),
              alpha = .3, fill = color_hcw) +
  geom_point(color = color_hcw) +
  geom_line(color = color_hcw) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_months +
  rotate_x_text(90) +
  facet_wrap(sous_coordination ~ ., nrow = 2) +
  large_txt +
  custom_vert_facet +
  labs(title = "Proportion de cas qui sont des travailleurs de la santé\npar sous-coordination",
       x = "Mois de notification",
       y = "% de cas mensuels")


## step 5
table_hcw_sub_coordination <- hcw_sub_coordination %>% 
  select(sous_coordination,
         "% travailleurs de la santé" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_hcw_sub_coordination %>%
  show_table()


## step 6
table_hcw_sub_coordination_time <- hcw_sub_coordination_time %>% 
  select(mois = month_report,
         sous_coordination,
         "% travailleurs de la santé" = p,
         "IC95% lower" = p_lower,
         "IC95% upper" = p_upper,
         n = denom,
         everything())

table_hcw_sub_coordination_time %>%
  show_table()
      
```






<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# Data completeness {.tabset .tabset-fade .tabset-pills}

<!-- ======================================================= -->
## Outline 

In the above tables, we can calculate the completeness as 'n / total', 
where 'n' excludes 'unknown'. Here, we plot:

* overall completeness



<!-- ======================================================= -->
## Overall

```{r completeness}

completeness <- data.frame(
    known_contact = 100 * contacts_overall$denom / contacts_overall$total,
    followed = 100 * followed_overall$denom / followed_overall$total,
    community_deaths = 100 * community_deaths_overall$denom / community_deaths_overall$total,
    hcw_cases = 100 * hcw_overall$denom / hcw_overall$total) %>%
  gather(labels, completeness) 

ggplot(completeness, aes(x = labels, y = completeness)) +
  theme_bw() +
  geom_col(fill = color_known_contact) +
  scale_y_continuous(limits = c(0, 100)) +
  large_txt +
  labs(title = "Reporting Completeness",
             x = "",
             y = "% of cases with data for each variable")


```




<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

# Export tables {.tabset .tabset-fade .tabset-pills}

## Outline

Provide an outline of exported files.


## Excel files

```{r xlsx_exports}

if (!dir.exists("produced_xlsx")) {
  dir.create("produced_xlsx")
}

to_export <- c("table_contacts_overall",
               "table_contacts_overall_time",
               "table_contacts_sub_coordination",
               "table_contacts_sub_coordination_time",
               "table_contacts_top_zones",
               "table_contacts_top_zones_time",
               "table_followed_overall",
               "table_followed_overall_time",
               "table_followed_sub_coordination",
               "table_followed_sub_coordination_time",
               "table_followed_top_zones",
               "table_followed_top_zones_time",
               "table_community_deaths_overall",
               "table_community_deaths_overall_time",
               "table_community_deaths_sub_coordination",
               "table_community_deaths_sub_coordination_time",
               "table_community_deaths_top_zones",
               "table_community_deaths_top_zones_time",
               "table_hcw_overall",
               "table_hcw_overall_time",
               "table_hcw_sub_coordination",
               "table_hcw_sub_coordination_time")

for (e in to_export) {
  rio::export(get(e),
              file.path("produced_xlsx",
                        paste0(e, ".xlsx")))
}

```

Click on the following links to open the files (only works if the files above
have been generated and are in the same folder as this document):


```{r links, results = "asis"}

for (e in to_export) {
  txt <- sprintf("- [%s.xlsx](%s.xlsx)",
                 e,
                 file.path("produced_xlsx",
                           e))
  cat(txt, sep = "\n")
}

```








<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
# System information {.tabset .tabset-fade .tabset-pills}

<!-- ===================================================== -->
## Outline

The following information documents the system on which the document was
compiled.



<!-- ===================================================== -->
## System 

This provides information on the operating system.

```{r system_info}
Sys.info()
```



<!-- ===================================================== -->
## R environment

This provides information on the version of R used:

```{r R_session}
R.version
```



<!-- ===================================================== -->
## R packages

This provides information on the packages used:

```{r R_pkg}
sessionInfo()
```




<!-- ===================================================== -->
## Compilation parameters

This shows which parameters were passed through `params` at compilation time:

```{r params}
params
```



<!-- ===================================================== -->
## Change log

### Version 1.0.0

